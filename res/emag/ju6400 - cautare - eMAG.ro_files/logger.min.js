if("undefined"==typeof Emag)var Emag={};"undefined"==typeof Emag.Widgets&&(Emag.Widgets={}),"undefined"==typeof Emag.Widgets.Tracking&&(Emag.Widgets.Tracking={}),"undefined"==typeof Emag.Widgets.Tracking.Config&&(Emag.Widgets.Tracking.Config={}),Emag.Widgets.Tracking.Exceptions={NoConfigException:function(e){return this.name="Script Error",this.level="Show Stopper",this.message="undefined"!=typeof e?e:"The instance config is missing.",this.htmlMessage="undefined"!=typeof e?e:"The instance config is missing.",this.toString=function(){return this.name+": "+this.message},this},AjaxException:function(e){return this.name="Script Error",this.level="Show Stopper",this.message="undefined"!=typeof e?e:"An error occured while loading file.",this.htmlMessage="undefined"!=typeof e?e:"An error occured while loading file.",this.toString=function(){return this.name+": "+this.message},this}},Emag.Widgets.Tracking.Logger={_cookies:{},_pageType:null,_config:{},_references:{loaded:{},viewed:{}},_timer:null,_trackingTimeout:2e4,_cookieKey:"Emag.Widgets.Tracking.Logger._cookies",debug:!1,_processCookies:function(){try{this._cookies=null!=$.parseJSON($.cookie(this._cookieKey))?$.parseJSON($.cookie(this._cookieKey)):{}}catch(e){}"undefined"!=typeof this._cookies.debug&&(this.debug="true"==this._cookies.debug),this.debug===!0&&(console.info("Processing cookies for Emag.Widgets.Tracking.Logger"),console.debug("_processCookies"))},_setupEvents:function(){var e=this;this.debug===!0&&(console.info("Setting up events for Emag.Widgets.Tracking.Logger"),console.debug("_setupEvents")),$(this).bind("parse",function(e,t,i){this._parse(t,i)}),$(this).bind("_data_done",function(e,t){this.debug===!0&&(console.info("data sent: done"),console.log(t))}),$(this).bind("_data_fail",function(e,t){this.debug===!0&&(console.error("data sent: fail"),console.log(t))}),$(this).bind("_exit",function(e){this.debug===!0&&(console.info("Terminating Emag.Widgets.Tracking.Logger"),console.debug("_exit"),console.log(this))}),$(this).bind("scroll",function(t){e._scroll()}),$(this).bind("stash",function(t){e._stash()}),$(this).bind("track",function(t){e._track()}),$(this).bind("timer",function(t){e.startTimer()})},setPageType:function(e){this._pageType=e||null},getTrackingEventStructure:function(){var e=this;return{page_type:e._pageType,engines:{},events:{load:[],view:[]}}},_hasDeferredData:function(){var e=!1;if("undefined"!=typeof this._deferred_events.events)for(var t in this._deferred_events.events)for(var i in this._deferred_events.events[t])if(this._deferred_events.events[t][i].widgets.length>0)var e=!0;else delete this._deferred_events.events[t][i];return e},_track:function(){var e=this;this.debug===!0&&(console.info("Tracking deferred data events..."),console.debug("_track"));var t=$.Deferred(),i=e._hasDeferredData();if(i===!0)try{$.ajax({url:"/widgets/track.json",type:"POST",dataType:"json",data:{data:e._deferred_events}}).done(function(i){e.debug===!0&&console.debug(e._deferred_events),e._deferred_events=e.getTrackingEventStructure(),t.resolve(i)}).fail(function(e,i,n){throw t.reject({}),Emag.Widgets.Tracking.Exceptions.AjaxException(n)})}catch(n){e.debug===!0&&console.error(n.message),t.resolve({})}else e.debug===!0&&console.info("No deferred data events available"),t.resolve({});return t.promise()},startTimer:function(){var e=this;this._timer=setInterval(function(){$.when(e._track()).done(function(){$(e).trigger("_stash")}).fail(function(){}).always(function(){})},e._trackingTimeout)},init:function(){this._processCookies(),this._setupEvents(),this.debug===!0&&console.info("Initializing Emag.Widgets.Tracking.Logger"),this._references.loaded[window.location.href]=[],this._references.viewed[window.location.href]=[],this._deferred_events="undefined"!=typeof this._cookies.tracking_events?this._cookies.tracking_events:this.getTrackingEventStructure(),this._parse("body","_load"),this._watch("body")},_parse:function(e,t){var i=this;this.debug===!0&&(console.info('Prepare parsing selector "'+e+'"'),console.debug("_parse")),"undefined"!=typeof e&&$.when(this._load(e,t)).done(function(e){$(i).trigger("_data_done",e)}).fail(function(e){$(i).trigger("_data_fail",e)}).always(function(){i._exit()})},_processReference:function(e){if(e.length>1){var t=e.match(/[0-9]+/);isNaN(e.slice(-1))?null!==t&&t.length>0&&(e=e.substr(0,e.indexOf(t[0])+t[0].length)):(e=e.substr(0,e.length-1),e=this._processReference(e)),"_"==e.slice(-1)&&(e=e.substr(0,e.length-1)),-1!=e.indexOf("#")&&(e=e.substr(0,e.indexOf("#")))}return e},_stash:function(){this.debug===!0&&(console.info("Stashing deferred data events..."),console.debug("_stash"));var e=this._hasDeferredData();e===!1&&(this._deferred_events=this.getTrackingEventStructure()),this._cookies.tracking_events=this._deferred_events;var t=JSON.stringify(this._cookies);t.length<2048?$.cookie(this._cookieKey,t,{expires:1,path:"/"}):$.cookie(this._cookieKey,null,{path:"/"})},_scroll:function(){var e=this;this.debug===!0&&(console.info("Detect scrolling..."),console.debug("_scroll"));var t=this._prepareData();t.trigger="_scroll",t.events.view[0].timestamp=Math.floor(Date.now()/1e3),"undefined"==typeof this._deferred_events&&(this._deferred_events=this.getTrackingEventStructure()),$.each(this._references.loaded[window.location.href],function(i,n){if(-1===$.inArray(n,e._references.viewed[window.location.href])){var s=$("a[href*='"+n+"'").attr("href"),r=$("a[href*='"+n+"'").first().is(":in-viewport");r&&-1===$.inArray(n,t.events.view[0].widgets)&&(t.engines[n]=e._getProvider(s),t.events.view[0].widgets.push(n),e._references.viewed[window.location.href].push(n))}}),t.events.view[0].widgets.length>0&&($.extend(!0,this._deferred_events.engines,t.engines),this._deferred_events.trigger=t.trigger,this._deferred_events.events.view.push(t.events.view[0]))},_prepareData:function(){var e=this.getTrackingEventStructure();return e.events.load.push({url:window.location.href,referrer:null,timestamp:null,category_id:0,product_id:0,brand_id:0,widgets:[]}),e.events.view.push({url:window.location.href,referrer:null,timestamp:null,category_id:0,product_id:0,brand_id:0,widgets:[]}),dataLayer.length>0&&$.each(dataLayer,function(t,i){$.each(i,function(t,i){"product_id"===t?(e.events.load[0].product_id=i,e.events.view[0].product_id=i):"category_id"===t?(e.events.load[0].category_id=i,e.events.view[0].category_id=i):"brand_id"===t&&(e.events.load[0].brand_id=i,e.events.view[0].brand_id=i)})}),e},_getProvider:function(e){var t="emag",i=e.match(/[\?&]recid=/);if(null!==i&&i.length>0){var n=i.input.substr(i.index).match(/[a-z0-9]+\-[a-z0-9]+\-[a-zA-Z0-9_\.]+\-[a-z0-9]+/);if(null!==n&&n.length>0)var t="gravity"}return t},_load:function(e,t){var i=this;this.debug===!0&&(console.info('Parsing selector "'+e+'"'),console.debug("_load"));var n=this._prepareData();n.trigger=t,"undefined"==typeof this._deferred_events&&(this._deferred_events=this.getTrackingEventStructure()),$(e).find("a[href*='ref=']").each(function(){var e=$(this).attr("href"),t=e.match(/[\?&]ref=/);if(null!==t&&t.length>0){var s=-1!=e.indexOf("&",t.index)?e.indexOf("&",t.index):e.length,r=e.substr(t.index+t[0].length,s-t.index-t[0].length);if(r=i._processReference(r),-1===$.inArray(r,n.events.load[0].widgets)&&-1===$.inArray(r,i._references.loaded[window.location.href])){"undefined"==typeof n.engines[r]&&(n.engines[r]=i._getProvider(e)),n.events.load[0].widgets.push(r);var o=$(this).is(":in-viewport");o&&(n.events.view[0].widgets.push(r),i._references.viewed[window.location.href].push(r)),i._references.loaded[window.location.href].push(r)}}});var s=$.Deferred();if(n.events.load[0].widgets.length>0||n.events.view[0].widgets.length>0){0==n.events.load[0].widgets.length&&delete n.events.load,0==n.events.view[0].widgets.length&&delete n.events.view;try{$.ajax({url:"/widgets/track.json",type:"POST",dataType:"json",data:{data:n}}).done(function(e){i.debug===!0&&console.debug(n),delete n,s.resolve(e)}).fail(function(e,t,i){throw s.reject({}),Emag.Widgets.Tracking.Exceptions.AjaxException(i)})}catch(r){i.debug===!0&&console.error(r.message),s.resolve({})}}else i.debug===!0&&console.info('No more extra data available to load from selector "'+e+'"'),s.resolve({});return s.promise()},_watch:function(e){var t=this;this.debug===!0&&(console.info('Watching selector "'+e+'"'),console.debug("_watch")),$(document).ajaxComplete(function(e,i,n){if("/widgets/track.json"!=n.url&&(t.debug===!0&&console.info('Ajax complete event detected on "'+n.url+'"'),"undefined"!=typeof i&&200==i.status&&4==i.readyState))try{t._parse("body","_ajax")}catch(s){t.debug===!0&&console.error(s.message)}}),$(window).bind("scroll",function(e){$(t).trigger("scroll")}),$(window).unload(function(){$(t).trigger("stash")}),$(this).trigger("track"),$(this).trigger("timer")},_exit:function(){$(this).trigger("_exit")}};